# knowledge.py - 股市新手村 (V68 K線戰術詳細擴充版)

# --- 原有的名詞解釋 (維持不變) ---
STOCK_TERMS = {
    "🔰 交易規則與基礎術語": {
        "T+2 交割制度": """
**【定義】**
台股實施「T+2」日交割制度。
若您在 T日 (今天) 買進股票，必須在 T+2 日 (後天) 上午 10 點前，確認銀行交割帳戶內有足夠的款項扣款。

**【實戰風險】**
若 T+2 日帳戶餘額不足，就會發生 **「違約交割」**。
這不僅會嚴重影響個人信用紀錄 (聯徵)，導致未來無法辦信用卡或貸款，嚴重者甚至面臨法律責任與賠償。
""",
        "漲跌停限制 (Limit Up/Down)": """
**【定義】**
台股每日股價漲跌幅限制為參考價的 10%。

**【判讀技巧】**
* **🔴 漲停 (Limit Up)**：買氣極強，只有買單沒有賣單。通常代表主力強勢表態，隔日容易開高，是短線強勢的象徵。
* **🟢 跌停 (Limit Down)**：賣壓極重，只有賣單沒有買單。需小心流動性風險（想賣賣不掉）。
""",
        "試撮 (Pre-market Match)": """
**【定義】**
開盤前 (08:30-09:00) 與收盤前 (13:25-13:30) 的模擬撮合階段，會顯示「試算成交價」。

**【主力陷阱】**
主力常利用試撮掛出「假單」來誤導散戶。例如掛漲停買進，吸引散戶跟單，但在 08:59:59 瞬間抽單，導致開盤不如預期。**切記：試撮價格僅供參考，勿盡信。**
""",
        "ROD / IOC / FOK": """
**【委託種類詳解】**
* **ROD (Rest of Day)**：當日有效單。一般散戶最常用，掛單後直到收盤都有效。
* **IOC (Immediate or Cancel)**：立即成交否則取消。只想買現在的價格，沒買到的部分直接取消，不留單。
* **FOK (Fill or Kill)**：全部成交否則取消。要嘛全買，要嘛一張都不買（通常是大戶使用）。
"""
    },
    "📊 進階技術指標 (Technical)": {
        "K線 (Candlestick)": """
**【定義】**
紀錄股價單日走勢的圖形。包含開盤價、收盤價、最高價、最低價。

**【實戰口訣】**
* **🔴 紅K (陽線)**：收盤 > 開盤。代表多方勝，實體越長，買氣越強。
* **🟢 綠K (陰線)**：收盤 < 開盤。代表空方勝，實體越長，賣壓越重。
* **影線**：上影線代表上方有壓力（有人在賣）；下影線代表下方有支撐（有人在接）。
""",
        "MA 移動平均線 (Moving Average)": """
**【定義】**
過去 N 天收盤價的平均值，代表市場的「平均成本」。

**【關鍵參數】**
* **5日線 (5MA / 週線)**：短線攻擊發起線。強勢股不應跌破此線。
* **20日線 (20MA / 月線)**：波段生命線。多頭趨勢的回檔支撐，跌破代表趨勢轉弱。
* **60日線 (60MA / 季線)**：中長線景氣線。大型股或存股族的重要防守點。
""",
        "成交量 (Volume)": """
**【定義】**
當日該股票成交的總張數。

**【量價關係】**
* **有量才有價**：股價上漲必須伴隨成交量放大 (價漲量增)，代表買氣真實。
* **量縮整理**：股價下跌或盤整時，成交量縮小是好事，代表賣壓減輕。
* **爆量長黑**：高檔爆出巨量且收長黑K，通常是主力出貨的訊號，應儘速離場。
""",
        "KD 隨機指標": """
**【定義】**
由 K 值與 D 值組成，數值介於 0-100，用來判斷股價強弱。

**【應用技巧】**
* **黃金交叉**：K 值由下往上穿過 D 值，視為買進訊號 (低檔 20 附近準確度高)。
* **死亡交叉**：K 值由上往下穿過 D 值，視為賣出訊號 (高檔 80 附近準確度高)。
* **高檔鈍化**：KD 長期維持在 80 以上不下來，代表趨勢極度強勢，這時不應看空，反而可能有大波段。
"""
    },
    "💰 籌碼與主力解密 (Chips)": {
        "三大法人": """
**【定義】**
市場上資金最雄厚的三種機構投資人。
* **外資**：外國機構。資金最大，偏好大型權值股 (如台積電)，操作屬波段性質。
* **投信**：國內基金公司。資金來自散戶募集，偏好中小型股，有季底作帳行情，對中小型飆股影響力大。
* **自營商**：券商自己的投資部門。操作極短線，常做避險，參考價值相對較低。
""",
        "融資融券 (Margin Trading)": """
**【定義】**
信用交易，向券商借錢或借股票。
* **融資 (借錢買股)**：散戶指標。融資餘額過高代表籌碼凌亂，主力不易拉抬，容易有多殺多風險。
* **融券 (借券賣股)**：看空指標。若融券餘額暴增但股價不跌，容易發生「軋空」行情 (主力硬拉股價強迫空頭回補)。
""",
        "籌碼集中度": """
**【定義】**
買方前 15 大券商的買超張數佔總成交量的比例。

**【判讀】**
* **集中度高**：代表籌碼流向少數特定人（主力）手中，股價易漲難跌。
* **集中度低**：代表籌碼分散在散戶手中，股價容易受市場情緒波動。
"""
    },
    "🏢 基本面與財報 (Fundamentals)": {
        "EPS (每股盈餘)": """
**【定義】**
Earnings Per Share。公司每一股賺了多少錢。
**【意義】**
是股價的長期基石。EPS 持續成長的股票，股價長線才有上漲的底氣。
""",
        "本益比 (P/E Ratio)": """
**【定義】**
股價 / EPS。代表投資人願意花多少年回本。

**【應用】**
* **< 10倍**：股價可能被低估，或是該產業正處於衰退中。
* **> 20倍**：市場給予高期待，常見於高成長科技股。
""",
        "MoM / YoY (營收成長率)": """
**【定義】**
* **MoM (Month on Month)**：月增率。跟上個月比，檢視短期動能。
* **YoY (Year on Year)**：年增率。跟去年同月比。

**【實戰】**
YoY 是最重要的指標，因為它排除了淡旺季因素。若一家公司 YoY 連續 3 個月大幅成長 (>20%)，很有可能是下一檔飆股。
"""
    },
    "🐉 股市俚語與心法": {
        "割韭菜": "**定義**：散戶反覆追高殺低，資金不斷縮水，像韭菜一樣被主力收割。",
        "抬轎": "**定義**：你在低點買進，主力或晚進場的人幫你把股價推上去，讓你獲利。",
        "洗盤": "**定義**：主力故意讓股價劇烈震盪，把信心不足的散戶嚇跑，以便在低檔收集籌碼。",
        "畢業": "**定義**：本金賠光，黯然退出股市。",
        "左側交易": "**定義**：在股價下跌時預測底部買進（越跌越買），風險較高，但成本低。",
        "右側交易": "**定義**：在股價打底完成、確認上漲趨勢後買進（追漲），成本稍高但勝率較高。"
    }
}

# --- V68 新增：K線型態詳細教學資料庫 (結構更新) ---
# 資料格式: [開盤, 最高, 最低, 收盤]
# 使用 HTML span 標籤進行顏色註記
KLINE_PATTERNS = {
    "bull": { # 多方型態
        "錘頭線 (Hammer)": {
            "morphology": "出現在下跌趨勢底部。實體很小 (紅綠皆可，紅K較佳)，**下影線極長** (至少實體2倍以上)，幾乎無上影線。",
            "psychology": "開盤後空方用力下殺，創出新低，但低檔買盤突然湧入，將股價硬生生推回高點附近收盤。代表**空方力竭，多方開始強勢反擊**。",
            "action": """
            <ul>
                <li><span style="color:#FF9F1C; font-weight:bold;">🟡【確認訊號】</span>：見此訊號不可馬上進場，必須等待隔日出現一根<b>實體紅K棒</b>，且收盤價高於錘頭線實體，才算確認止跌。</li>
                <li><span style="color:#FF2B2B; font-weight:bold;">🔴【進場點位】</span>：確認訊號出現當日的尾盤，或隔日拉回不破錘頭低點時。</li>
                <li><span style="color:#FF2B2B; font-weight:bold;">🔴【停損設定】</span>：嚴格設定在<b>錘頭線下影線的最低點</b>跌破時。</li>
            </ul>
            """,
            "data": [[100, 100, 92, 99]]
        },
        "多頭吞噬 (Bullish Engulfing)": {
            "morphology": "第一根為綠K (跌)，第二根為長紅K (漲)。重點是**第二根紅K的實體部分，必須完全包覆住第一根綠K的實體**。",
            "psychology": "原本空方佔優勢，但隔日多方以壓倒性的力量開低走高，將昨日的賣壓全數吃掉，並創出新高。這是**極強的底部反轉訊號**。",
            "action": """
            <ul>
                <li><span style="color:#FF9F1C; font-weight:bold;">🟡【確認訊號】</span>：第二根長紅K棒必須伴隨<b>成交量明顯放大</b>，代表主力真金白銀介入。</li>
                <li><span style="color:#FF2B2B; font-weight:bold;">🔴【進場點位】</span>：長紅K棒收盤確認時可嘗試進場，或等待隔日小幅拉回時介入。</li>
                <li><span style="color:#FF2B2B; font-weight:bold;">🔴【停損設定】</span>：以該根<b>長紅K棒的最低點</b>為防守點。</li>
            </ul>
            """,
            "data": [[100, 100, 95, 96], [95, 103, 95, 102]]
        },
        "晨星 (Morning Star)": {
            "morphology": "由三根K線組成標準轉折：1. 長綠K (跌勢不止) → 2. 跳空低開的小星星 (多空交戰，實體極小) → 3. 長紅K (多方反攻，收復第一根跌幅一半以上)。",
            "psychology": "市場在絕望的殺盤中跳空見底，隨後多方強勢介入收復失土。這是一個**勝率極高、結構紮實的波段起漲點**。",
            "action": """
            <ul>
                <li><span style="color:#FF9F1C; font-weight:bold;">🟡【確認訊號】</span>：第三根紅K的收盤價位置越高 (越接近第一根綠K開盤價)，反轉力道越強。</li>
                <li><span style="color:#FF2B2B; font-weight:bold;">🔴【進場點位】</span>：第三根紅K收盤確認時是標準買點。</li>
                <li><span style="color:#FF2B2B; font-weight:bold;">🔴【停損設定】</span>：以中間那顆<b>「星星」的最低點</b>為絕對防守點。</li>
            </ul>
            """,
            "data": [[105, 105, 95, 96], [94, 95, 93, 94], [96, 104, 96, 103]]
        },
        "紅三兵 (Three White Soldiers)": {
            "morphology": "在底部或整理區後，連續出現三根中小型的紅K棒，收盤價一天比一天高，且每日開盤價都在前一日實體內 (步步高升)。",
            "psychology": "代表多頭部隊穩步推進，賣壓被逐日化解，市場信心恢復，趨勢已由空翻多。通常是**波段漲勢的開端**。",
            "action": """
            <ul>
                <li><span style="color:#FF2B2B; font-weight:bold;">🔴【進場點位】</span>：趨勢確立，不可追高。等待股價拉回測試 5日均線不破時，是最佳買點。</li>
                <li><span style="color:#FF2B2B; font-weight:bold;">🔴【停損設定】</span>：跌破<b>第一根紅K的低點</b>，代表漲勢失敗。</li>
            </ul>
            """,
            "data": [[90, 93, 90, 92], [92, 95, 91, 94], [94, 98, 93, 97]]
        },
        "破底翻 (Spring)": {
            "morphology": "股價跌破前波重要的支撐低點後，迅速在 1-2 天內拉回，並強勢站上前低之上，通常會留下長下影線。",
            "psychology": "這是主力慣用的**「假跌破、真拉抬」**手法。故意摜破支撐以誘發散戶的停損賣壓 (洗盤)，收集完籌碼後迅速拉起。",
            "action": """
            <ul>
                <li><span style="color:#FF9F1C; font-weight:bold;">🟡【確認訊號】</span>：一定要等待股價<b>收盤確認重新站回支撐區之上</b>，才算破底翻成功。</li>
                <li><span style="color:#FF2B2B; font-weight:bold;">🔴【進場點位】</span>：確認站回支撐後的隔日，是勝率極高的大膽買點。</li>
                <li><span style="color:#FF2B2B; font-weight:bold;">🔴【停損設定】</span>：再次跌破<b>最低點 (假跌破的低點)</b> 時，必須立即停損。</li>
            </ul>
            """,
            "data": [[100, 102, 98, 100], [100, 100, 90, 92], [92, 105, 92, 103]]
        }
    },
    "bear": { # 空方型態
        "上吊線 (Hanging Man)": {
            "morphology": "形狀與錘頭線完全一樣 (小實體、長下影線)，但關鍵是它出現在**高檔上漲趨勢中**。",
            "psychology": "高檔理應強勢，卻出現盤中大幅下殺的走勢。雖然收盤主力勉強拉回，但顯示**籌碼已經開始鬆動，主力邊拉邊出**，多方力道轉弱。",
            "action": """
            <ul>
                <li><span style="color:#FF9F1C; font-weight:bold;">🟡【確認訊號】</span>：見此訊號為強烈警戒。若隔日出現一根<b>實體綠K棒</b>，且收盤價低於上吊線實體，確認頭部形成。</li>
                <li><span style="color:#00E050; font-weight:bold;">🟢【離場時機】</span>：確認訊號出現時，多單應立即獲利了結或減碼。</li>
                <li><span style="color:#00E050; font-weight:bold;">🟢【放空點位】</span>：激進者可在跌破上吊線低點時嘗試放空，設上吊線高點為停損。</li>
            </ul>
            """,
            "data": [[50, 55, 50, 54], [54, 58, 54, 57], [57, 57, 50, 56]]
        },
        "空頭吞噬 (Bearish Engulfing)": {
            "morphology": "高檔出現一根紅K，隔日出現一根更長的綠K。重點是**第二根綠K的實體部分，必須完全包覆住第一根紅K的實體**。",
            "psychology": "多方攻勢耗盡，空方以壓倒性的力量反撲，將昨日追高的買盤全數套牢。這是**極強的頭部反轉訊號**。",
            "action": """
            <ul>
                <li><span style="color:#FF9F1C; font-weight:bold;">🟡【確認訊號】</span>：第二根長綠K若伴隨爆量，代表主力大力出貨，確認度更高。</li>
                <li><span style="color:#00E050; font-weight:bold;">🟢【離場時機】</span>：逃命波！不要留戀，長綠K收盤確認時應清倉。</li>
                <li><span style="color:#00E050; font-weight:bold;">🟢【停損設定】</span>：若不幸被套牢，反彈站不回<b>長綠K實體中值</b>時，務必停損。</li>
            </ul>
            """,
            "data": [[100, 102, 98, 101], [102, 103, 95, 96]]
        },
        "夜星 (Evening Star)": {
            "morphology": "與晨星相反，出現在高檔：1. 長紅K (多頭最後衝刺) → 2. 跳空高開的小星星 (高檔迷航，無力續攻) → 3. 長綠K (空方正式接管，跌入第一根紅K實體內)。",
            "psychology": "股價創新高後買盤後繼無力，隨後重挫。上方形成沉重的「孤島」套牢區，壓力極大。",
            "action": """
            <ul>
                <li><span style="color:#00E050; font-weight:bold;">🟢【離場時機】</span>：第三根綠K確認成型時，是最後逃生門，多單必須離場。</li>
                <li><span style="color:#00E050; font-weight:bold;">🟢【放空點位】</span>：第三根綠K收盤是標準空點。</li>
                <li><span style="color:#00E050; font-weight:bold;">🟢【停損設定】</span>：以中間那顆<b>「星星」的最高點</b>為絕對防守點 (空單停損點)。</li>
            </ul>
            """,
            "data": [[95, 102, 95, 101], [103, 104, 102, 103], [102, 102, 92, 93]]
        },
        "黑三鴉 (Three Black Crows)": {
            "morphology": "在高檔或整理區後，連續出現三根中小型的綠K棒，收盤價一天比一天低，且每日開盤都在前一日實體內 (步步走低)。",
            "psychology": "代表主力連續調節倒貨，買盤完全潰散，市場恐慌氣氛蔓延，股價如自由落體般下跌。",
            "action": """
            <ul>
                <li><span style="color:#00E050; font-weight:bold;">🟢【離場時機】</span>：趨勢已轉空，任何反彈至 5日均線附近皆是逃命點，切勿隨意接刀攤平。</li>
                <li><span style="color:#00E050; font-weight:bold;">🟢【防守重點】</span>：若股價無法在短期內站回<b>第一根綠K的高點</b>，空頭趨勢將持續。</li>
            </ul>
            """,
            "data": [[105, 105, 100, 102], [102, 102, 96, 98], [98, 98, 92, 94]]
        },
        "流星線 (Shooting Star)": {
            "morphology": "出現在高檔。實體很小 (紅綠皆可，綠K賣壓更重)，**上影線極長** (至少實體2倍以上)，幾乎無下影線。",
            "psychology": "開盤多方試圖攻擊創新高，但遭遇空方強烈打壓，收盤被壓回低點。代表**上方壓力極大**，有人在這種價位大量倒貨。",
            "action": """
            <ul>
                <li><span style="color:#FF9F1C; font-weight:bold;">🟡【確認訊號】</span>：此為短線警戒訊號。觀察隔日是否能越過上影線高點。</li>
                <li><span style="color:#00E050; font-weight:bold;">🟢【離場時機】</span>：若隔日開低或無法越過流星線高點，多單建議獲利了結。</li>
                <li><span style="color:#00E050; font-weight:bold;">🟢【防守重點】</span>：<b>流星線的最高點</b>是重要壓力關卡，突破不了就是空點。</li>
            </ul>
            """,
            "data": [[100, 110, 100, 101]]
        }
    }
}

STRATEGY_DESC = """
### 🤖 AI V62 高勝率策略邏輯解密 (同前略)
...
"""
